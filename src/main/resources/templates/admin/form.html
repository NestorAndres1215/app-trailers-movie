<!DOCTYPE html>
<html lang="es"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{master.html}"
	  class="scroll-smooth">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title th:if="${pelicula?.id}">Editar <span th:text="${pelicula.titulo}">Película</span></title>
	<title th:unless="${pelicula?.id}">Nueva Película - CinemaTrailer</title>

	<!-- Tailwind CSS -->
	<script src="https://cdn.tailwindcss.com"></script>

	<!-- Select2 -->
	<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

	<script>
		tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cinema-red': '#8B0000',
                        'cinema-gold': '#D4AF37',
                        'cinema-dark': '#121212',
                        'cinema-gray': '#1a1a1a',
                    },
                    fontFamily: {
                        'cinzel': ['Cinzel', 'serif'],
                        'montserrat': ['Montserrat', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.8s ease-out',
                        'pulse': 'pulse 2s infinite',
                        'bounce-subtle': 'bounceSubtle 0.6s ease-out',
                    }
                }
            }
        }
	</script>

	<style>
		.glass-card { @apply bg-cinema-gray/80 backdrop-blur-xl border border-cinema-gold/30 rounded-2xl shadow-2xl; }
        .form-input { @apply w-full px-4 py-3 bg-cinema-dark/50 border border-cinema-gold/30 rounded-xl text-white placeholder-gray-400 focus:ring-2 focus:ring-cinema-gold/50 focus:border-cinema-gold transition-all duration-300; }
        .form-input.error { @apply border-red-500 focus:ring-red-500/50 focus:border-red-500; }
        .form-label { @apply block text-sm font-semibold text-cinema-gold mb-2 font-montserrat; }
        .error-message { @apply text-red-400 text-sm mt-1 flex items-center gap-1; }
        .btn-primary { @apply inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-cinema-red to-red-800 text-white font-semibold rounded-full shadow-lg hover:shadow-cinema-gold/40 hover:scale-105 transition-all duration-300; }
        .btn-secondary { @apply inline-flex items-center gap-2 px-6 py-3 bg-cinema-gray/80 text-cinema-gold border border-cinema-gold/50 rounded-full font-semibold hover:bg-cinema-gray transition-all duration-300 hover:scale-105; }
        .image-preview { @apply w-full max-w-md h-64 object-cover rounded-xl border-2 border-cinema-gold/50 shadow-lg; }
        .select2-container .select2-selection { @apply bg-cinema-dark/50 border-cinema-gold/30 text-white rounded-xl h-12; }
        .select2-container--default .select2-selection--multiple { @apply border-cinema-gold/30 min-h-12; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice { @apply bg-cinema-red/50 text-cinema-gold border-cinema-gold/50; }
	</style>
</head>
<body class="bg-cinema-dark text-gray-100 min-h-screen">

<div layout:fragment="content" th:object="${pelicula}" class="max-w-4xl mx-auto px-4 py-24">

	<!-- Título -->
	<div class="text-center mb-12 animate-fade-in">
		<h1 class="text-4xl md:text-5xl font-cinzel font-bold mb-4">
            <span class="bg-gradient-to-r from-cinema-gold to-yellow-400 bg-clip-text text-transparent">
                <span th:if="${pelicula?.id}">Editar Película</span>
                <span th:unless="${pelicula?.id}">Nueva Película</span>
            </span>
		</h1>
	</div>

	<!-- Formulario -->
	<form th:action="${pelicula?.id} ? @{/admin/peliculas/{id}/guardar(id=*{id})} : @{/admin/peliculas/guardar}"
		  method="post" enctype="multipart/form-data" class="glass-card p-8 animate-fade-in">

		<!-- Título -->
		<div class="mb-6">
			<label for="titulo" class="form-label">Título</label>
			<input type="text" id="titulo" th:field="*{titulo}" placeholder="Digite el título de la película"
				   class="form-input" th:classappend="${#fields.hasErrors('titulo')} ? 'error' : ''">
			<div th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}" class="error-message">
				<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
					<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
				</svg>
				<span th:errors="*{titulo}">Error</span>
			</div>
		</div>

		<!-- Sinopsis -->
		<div class="mb-6">
			<label for="sinopsis" class="form-label">Sinopsis</label>
			<textarea id="sinopsis" th:field="*{sinopsis}" placeholder="Digite la sinopsis de la película"
					  rows="4" class="form-input" th:classappend="${#fields.hasErrors('sinopsis')} ? 'error' : ''"></textarea>
			<div th:if="${#fields.hasErrors('sinopsis')}" th:errors="*{sinopsis}" class="error-message"></div>
		</div>

		<!-- Fecha de Estreno -->
		<div class="mb-6">
			<label for="fechaEstreno" class="form-label">Fecha de Estreno</label>
			<input type="date" id="fechaEstreno" th:field="*{fechaEstreno}"
				   class="form-input" th:classappend="${#fields.hasErrors('fechaEstreno')} ? 'error' : ''">
			<div th:if="${#fields.hasErrors('fechaEstreno')}" th:errors="*{fechaEstreno}" class="error-message"></div>
		</div>

		<!-- YouTube Trailer ID -->
		<div class="mb-6">
			<label for="youtubeTrailerId" class="form-label">YouTube Trailer ID</label>
			<input type="text" id="youtubeTrailerId" th:field="*{youtubeTrailerId}"
				   placeholder="Ej: dQw4w9WgXcQ" class="form-input" th:classappend="${#fields.hasErrors('youtubeTrailerId')} ? 'error' : ''">
			<div class="mt-2" th:if="*{youtubeTrailerId}">
				<iframe th:src="'https://www.youtube.com/embed/' + *{youtubeTrailerId} + '?autoplay=0'"
						class="w-full h-48 rounded-xl" frameborder="0" allowfullscreen></iframe>
			</div>
			<div th:if="${#fields.hasErrors('youtubeTrailerId')}" th:errors="*{youtubeTrailerId}" class="error-message"></div>
		</div>

		<!-- Portada -->
		<div class="mb-6">
			<label for="portada" class="form-label">Portada</label>
			<input type="file" id="portada" name="portada" accept="image/*" class="form-input">
			<div id="imagePreview" class="mt-4 hidden">
				<img id="previewImg" class="image-preview" alt="Vista previa">
			</div>
			<div th:if="${#fields.hasErrors('portada')}" th:errors="*{portada}" class="error-message"></div>
			<div th:if="*{rutaPortada}" class="mt-4">
				<img th:src="@{/assets/{filename}(filename=*{rutaPortada})}" class="image-preview" th:alt="*{titulo}">
			</div>
		</div>

		<!-- Géneros -->
		<div class="mb-8">
			<label for="generos" class="form-label">Géneros</label>
			<select id="generos" th:field="*{generos}" multiple class="form-input">
				<option th:each="genero : ${generos}" th:value="${genero.id}" th:text="${genero.titulo}"></option>
			</select>
			<div th:if="${#fields.hasErrors('generos')}" th:errors="*{generos}" class="error-message"></div>
		</div>

		<!-- Botones -->
		<div class="flex flex-col sm:flex-row gap-4 justify-end pt-6 border-t border-cinema-gold/20">
			<a th:href="@{/admin/peliculas}" class="btn-secondary">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
				</svg>
				Cancelar
			</a>
			<button type="submit" class="btn-primary">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
				</svg>
				Guardar Película
			</button>
		</div>
	</form>
</div>

<div layout:fragment="scripts">
	<script>
		$(document).ready(function() {
            // Select2 para géneros
            $('#generos').select2({
                theme: 'default',
                placeholder: 'Selecciona uno o más géneros...',
                width: '100%',
                allowClear: true,
                closeOnSelect: false
            });

            // Previsualización de imagen
            $('#portada').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#previewImg').attr('src', e.target.result);
                        $('#imagePreview').removeClass('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Previsualización de YouTube
            $('#youtubeTrailerId').on('input', function() {
                const id = $(this).val().trim();
                if (id && id.length >= 11) {
                    $('iframe').attr('src', `https://www.youtube.com/embed/${id}?autoplay=0`);
                }
            });

            // Validación visual
            $('input, textarea, select').on('blur', function() {
                if ($(this).hasClass('error')) {
                    $(this).addClass('animate-pulse');
                    setTimeout(() => $(this).removeClass('animate-pulse'), 1000);
                }
            });

            // Animación de entrada
            $('.animate-fade-in').each(function(i) {
                $(this).css('opacity', '0').delay(i * 200).animate({opacity: 1}, 800);
            });
        });
	</script>
</div>

</body>
</html>